---
title: "eDNA"
author: "Jay T Lennon"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes:
  - \usepackage{array}
output: pdf_document
geometry: margin=2.54cm
---

Analysis of community sequence data to test whether the structure and composition of bacterial communities is affected by extracellular DNA

# Setup Work Environment 
```{r}
rm(list=ls())
getwd()
setwd("~/GitHub/eDNA")
require("vegan")
require("plyr")
source("./bin/DiversityFunctions.R")
source("./bin/MothurTools.R")
sem <- function(x, ...){sd(x, ...)/sqrt(length(na.omit(x)))}

# Define Inputs
  # Design       = general design file for experiment
  # shared       = OTU table from mothur with sequence similarity clustering
  # tax          = Taxonomy for 97% similarity OTUs
design       <- "./data/eDNA_Design.txt"
shared       <- "./mothur/output/eDNA.bac.final.shared"
tax          <- "./mothur/output/eDNA.trim.contigs.good.unique.good.filter.unique.precluster.pick.pick.an.unique_list.0.03.cons.taxonomy"
```

# Import Design
```{r}
design <- read.delim(design, header=T, row.names=1)
```

# Import Shared Files
```{r}
OTU <- read.otu(shared = shared, cutoff = "0.03")
```

# Remove OTUs with less than two occurences across all sites
```{r}
OTU <- OTU[, which(colSums(OTU) >= 2)]
```

# Coverage Stats
```{r}
cov.seqs <- count.groups(OTU)
cov.min <- min(cov.seqs) # 31,475
total.seqs <- sum(cov.seqs) # 12,916,632

# Good's coverage 
goods.c <- function(x = ""){
  1 - (apply(OTU, 1, function(x){sum(x == 1)}) / rowSums(x))
}
goods.c.eDNA <- goods.c(OTU)
mean.good.c <- mean(goods.c.eDNA) # 0.99
min.good.c <- min(goods.c.eDNA) # 0.98
```

# Alpha diversity
```{r}
# Mario's resampling to estimate alpha diversity in a sample (long)
# rich <- round(richness.iter(input = OTU, size = 30000,
#              iters = 100, shared="FALSE"), 3)
# even <- round(evenness.iter(input = OTU, size = 30000,
#              iters = 100, shared="FALSE", method="simp_even"), 3)

# Write output to files
write.table(rich, "data/rich.txt", sep = "\t", col.names = T, row.names = T)
write.table(even, "data/even.txt", sep = "\t", col.names = T, row.names = T)

# Read in alpha diversity files from above
rich2 <- read.table("./data/rich.txt", sep = "\t")
even2 <- read.table("./data/even.txt", sep = "\t")

# Merge data to design and calculate mean and sem per sample
rich.data <- merge(design, rich2, by = "row.names")
rich.mean <- round(apply(rich.data[8:(7+dim(rich)[2])], 1, mean, na.rm = TRUE),3)
rich.sem <- round(apply(rich.data[8:(7+dim(rich)[2])], 1, sem, na.rm = TRUE), 3)

even.data <- merge(design, even2, by = "row.names")
even.mean <- round(apply(even.data[8:(7+dim(even)[2])], 1, mean, na.rm = TRUE),3)
even.sem <- round(apply(even.data[8:(7+dim(even)[2])], 1, sem, na.rm = TRUE),4)

# Make new dataframe merging design file and mean diversity
eDNA.div <- data.frame(design, rich.mean, even.mean)

# Subset samples with technical replicates
eDNA.rep.samp <- eDNA.div[eDNA.div$tech.reps != 0,]
eDNA33_E <- apply(eDNA.rep.samp[8:(7+dim(even)[2])], 1, mean, na.rm = TRUE)
eDNA33_E <- ddply(eDNA.rep.samp, .(samp.code, env, treat, pair, qPCR.match), summarize, rich.mean = (rich.mean[treat == "E"]
  
  
  rich.mean[treat == "C"] / rich.mean[treat == "E"]))



# Calculate diversity ratio for DNase response variable
rich.ratio <- ddply(eDNA.div, .(samp.code, env), summarize, r.ratio = (rich.mean[treat == "C"] / rich.mean[treat == "E"]))

even.ratio <- ddply(eDNA.div, .(samp.code, env), summarize, e.ratio = (even.mean[treat == "C"] / even.mean[treat == "E"]))

# Richness ratio: table by enviromentb (does eDNA "inflate" diversity?)
rich.mean <- aggregate(rich.ratio$r.ratio ~ rich.ratio$env, rich.ratio, mean)
rich.sem <- aggregate(rich.ratio$r.ratio ~ rich.ratio$env, rich.ratio, sem)
rich.95 <- aggregate(rich.ratio$r.ratio ~ rich.ratio$env, rich.ratio, FUN = function(x) t.test(x)$conf.int[1:2])
rich.table <- data.frame(rich.mean, rich.sem[,2], rich.95[,2])
colnames(rich.table) <- c("env", "mean", "sem", "LCI", "UCI")

# Evenness ratio: table by enviroment (does eDNA "inflate" diversity?)
even.mean <- aggregate(even.ratio$e.ratio ~ even.ratio$env, even.ratio, mean)
even.sem <- aggregate(even.ratio$e.ratio ~ even.ratio$env, even.ratio, sem)
even.95 <- aggregate(even.ratio$e.ratio ~ even.ratio$env, even.ratio, FUN = function(x) t.test(x)$conf.int[1:2])
even.table <- data.frame(even.mean, even.sem[,2], even.95[,2])
colnames(even.table) <- c("env", "mean", "sem", "LCI", "UCI")
```

# Richness plot
```{r}
png(filename="figures/ratio.richness.png",
    width = 800, height = 800, res = 96*2)

plot.new()
rich.plot <- plot(rich.table$mean, ylim = c(-1, 5), 
      xlim = c(0.5, 4.5), pch = 22, bg = "white", lwd = 2, 
      cex = 3, yaxt = "n", xaxt = "n", cex.lab = 2, cex.axis = 1.5, 
      las = 1, ylab = "", xlab = "")
      box(lwd = 2)
abline(h = 1, lty = 3, lwd = 2)
arrows(x0 = c(1,2,3,4), y0 = rich.table$mean, y1 = rich.table$LCI, angle = 90,
       length = 0.1, lwd = 2)
arrows(x0 = c(1,2,3,4), y0 = rich.table$mean, y1 = rich.table$UCI, angle = 90,
       length=0.1, lwd = 2)
points(c(1:4), rich.table$mean,pch = 22, cex = 3, bg = "white", lwd = 2)

mtext(expression('Richness Ratio'), side = 2, 
      outer = TRUE, cex = 1.5, line = -2, adj = 0.5)
# Major Axes
axis(side = 2, lwd.ticks = 2, cex.axis = 1.5, las = 1,
    labels = c(-1, 1, 3, 5), at = c(-1, 1, 3, 5))
 
axis(side = 4, lwd.ticks = 2, cex.axis = 1.5, las = 1,
    at=c(-1, 1, 3, 5), labels = F)

axis(side = 1, lwd.ticks = 2, cex.axis = 0.9, las = 1,
    labels = c("Gut", "Sediment", "Soil", "Water"), at = c(1, 2, 3, 4))

axis(side = 3, lwd.ticks = 2, cex.axis = 1.5, las = 1,
    at = c(1, 2, 3, 4), labels = F)

# Close Plot Device
dev.off()
graphics.off()

# Show Plot
img <- readPNG("figures/ratio.richness.png")
grid.raster(img)
```

# Evenness plot
```{r}
png(filename="figures/ratio.evenness.png",
    width = 800, height = 800, res = 96*2)

plot.new()
even.plot <- plot(even.table$mean, ylim = c(-3, 7), 
      xlim = c(0.5, 4.5), pch = 22, bg = "white", lwd = 2, 
      cex = 3, yaxt = "n", xaxt = "n", cex.lab = 2, cex.axis = 1.5, 
      las = 1, ylab = "", xlab = "")
      box(lwd = 2)
abline(h = 1, lty = 3, lwd = 2)
arrows(x0 = c(1,2,3,4), y0 = even.table$mean, y1 = even.table$LCI, angle = 90,
       length = 0.1, lwd = 2)
arrows(x0 = c(1,2,3,4), y0 = even.table$mean, y1 = even.table$UCI, angle = 90,
       length=0.1, lwd = 2)
points(c(1:4), even.table$mean,pch = 22, cex = 3, bg = "white", lwd = 2)

mtext(expression('Evenness Ratio'), side = 2, 
      outer = TRUE, cex = 1.5, line = -2, adj = 0.5)
# Major Axes
axis(side = 2, lwd.ticks = 2, cex.axis = 1.5, las = 1,
    labels = c(-3, -1, 1, 3, 5, 7), at = c(-3, -1, 1, 3, 5, 7))
 
axis(side = 4, lwd.ticks = 2, cex.axis = 1.5, las = 1,
    at=c(-3, -1, 1, 3, 5, 7), labels = F)

axis(side = 1, lwd.ticks = 2, cex.axis = 0.9, las = 1,
    labels = c("Gut", "Sediment", "Soil", "Water"), at = c(1, 2, 3, 4))

axis(side = 3, lwd.ticks = 2, cex.axis = 1.5, las = 1,
    at = c(1, 2, 3, 4), labels = F)

# Close Plot Device
dev.off()
graphics.off()

# Show Plot
img <- readPNG("figures/ratio.evenness.png")
grid.raster(img)
```

# Beta diversity
```{r}
# Make presence-absence matrix
OTU.PA <- (OTU > 0) * 1

# Make relative abundence matrix
OTU.REL <- OTU
for(i in 1:dim(OTU)[1]){
  OTU.REL[i,] <- OTU[i,]/sum(OTU[i,])
  }

# Log-transform relative abundances
OTU.REL.log <- decostand(OTU, method="log")

eDNA.bc.dis <- vegdist(OTU.REL.log, method = "bray", binary = "FALSE")
eDNA.dis.mean <- mean(eDNA.bc.dis)

# Principal Coordinates Analysis (PCoA)
eDNA.PCoA <- cmdscale(eDNA.bc.dis, eig = TRUE, k = 3) 
explainvar1 <- round(eDNA.PCoA$eig[1] / sum(eDNA.PCoA$eig), 3) * 100
explainvar2 <- round(eDNA.PCoA$eig[2] / sum(eDNA.PCoA$eig), 3) * 100
explainvar3 <- round(eDNA.PCoA$eig[3] / sum(eDNA.PCoA$eig), 3) * 100
sum.eig <- sum(explainvar1, explainvar2, explainvar3)

# OTU Scores
otu.scores <- t(cor(eDNA.PCoA$points, OTU.REL))
otu.scores <- as.matrix(otu.scores)[,1:2]
otu.scores <- otu.scores[abs(otu.scores[,1]) > 0.7|abs(otu.scores[,2]) > 0.7,]

png(filename="figures/ordination.png",
    width = 1200, height = 800, res = 96*2)
layout(matrix(1:2, 1, 2), widths = c(9, 3))
par(mar = c(4, 5, 1, 0) + 0.5)

plot(eDNA.PCoA$points[ ,1], eDNA.PCoA$points[ ,2], 
     ylim = c(-0.6, 0.6), xlim = c(-0.6, 0.6), 
     xlab = paste("PCoA 1 (", explainvar1, "%)", sep = ""),
     ylab = paste("PCoA 2 (", explainvar2, "%)", sep = ""),
     #xlab = "", ylab = "", xaxt = "n", yaxt = "n",
     pch = 22, cex = 2.0, type = "n", cex.lab = 1.5, cex.axis = 1, 
     axes = FALSE)

# Add Axes
axis(side = 1, labels = T, lwd.ticks = 2, cex.axis = 1.25, las = 1)
axis(side = 2, labels = T, lwd.ticks = 2, cex.axis = 1.25, las = 1)
axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
axis(side = 1, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
axis(side = 2, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
abline(h = 0, v = 0, lty = 3)
box(lwd = 2)

# Subset data
eDNA.div.sort <- eDNA.div[order(eDNA.div[,1]) ,]
eDNA.points <- data.frame(eDNA.PCoA$points, eDNA.div.sort)

# Gut
eDNA.gut.C <- eDNA.points[ which(eDNA.points$env == "feces" & eDNA.points$treat == "C"), ]
eDNA.gut.E <- eDNA.points[ which(eDNA.points$env == "feces" & eDNA.points$treat == "E"), ]

# Sed
eDNA.sed.C <- eDNA.points[ which(eDNA.points$env == "sed" & eDNA.points$treat == "C"), ]
eDNA.sed.E <- eDNA.points[ which(eDNA.points$env == "sed" & eDNA.points$treat == "E"), ]

# Soil
eDNA.soil.C <- eDNA.points[ which(eDNA.points$env == "soil" & eDNA.points$treat == "C"), ]
eDNA.soil.E <- eDNA.points[ which(eDNA.points$env == "soil" & eDNA.points$treat == "E"), ]

# Water
eDNA.water.C <- eDNA.points[ which(eDNA.points$env == "water" & eDNA.points$treat == "C"), ]
eDNA.water.E <- eDNA.points[ which(eDNA.points$env == "water" & eDNA.points$treat == "E"), ]

# Add points

  # Gut C
points(eDNA.gut.C[ ,1], eDNA.gut.C[ ,2], pch = 21, 
       cex = 2, col = "red", bg = "white", lwd = 2) 
  # Gut E
points(eDNA.gut.E[ ,1], eDNA.gut.E[ ,2], pch = 21, 
       cex = 2, col = "red", bg = "red", lwd = 2)   

  # Sed C
points(eDNA.sed.C[ ,1], eDNA.sed.C[ ,2], pch = 22, 
       cex = 2, col = "darkgreen", bg = "white", lwd = 2) 
  # Sed E
points(eDNA.sed.E[ ,1], eDNA.sed.E[ ,2], pch = 22, 
       cex = 2, col = "darkgreen", bg = "darkgreen", lwd = 2) 

  # Soil C
points(eDNA.soil.C[ ,1], eDNA.soil.C[ ,2], pch = 24, 
       cex = 2, col = "brown", bg = "white", lwd = 2) 
  # Soil E
points(eDNA.sed.E[ ,1], eDNA.sed.E[ ,2], pch = 24, 
       cex = 2, col = "brown", bg = "brown", lwd = 2) 

  # Water C
points(eDNA.water.C[ ,1], eDNA.water.C[ ,2], pch = 23, 
       cex = 2, col = "blue", bg = "white", lwd = 2) 
  # Soil E
points(eDNA.water.E[ ,1], eDNA.water.E[ ,2], pch = 23, 
       cex = 2, col = "blue", bg = "blue", lwd = 2) 

par(mar = c(4, 0, 1, 1) + 0.5)
plot.new()
legend(0, 1, c("Gut", "Sediment", "Soil", "Water"), 
       pch = c(21, 22, 24, 23), pt.bg = c("red", "darkgreen", "brown", "blue"), 
       bty = "n", y.intersp = 1.5)
legend(0, 0.25, c("Control", "DNase"), pch = 22, pt.bg = c("white", "black"),
       bty = "n", y.intersp = 1.5)

# Close Plot Device
dev.off()
graphics.off()

# Show Plot
img <- readPNG("figures/ordination.png")
grid.raster(img)
```

# PERMANOVA
```{r}
eDNA.permanova <- adonis(OTU.REL.log ~ design$env * design$treat, 
    method = "bray", binary = FALSE)
eDNA.permanova


```

# Distances between pairs
```{r}
dist.raw <- vegdist(OTU.REL, method = "bray", upper = T, diag = T)
as.matrix(dist.raw)[1:5, 1:5]

design2 <- design[order(row.names(design)), ]

eDNA.permanova <- adonis(OTU.REL ~ design2$env * design2$treat, # strata = design2$pair,
    method = "bray", binary = FALSE)

eDNA.permanova

OTU.REL.log[1:5, 1:5]
design2[1:5,]

design.c <- design2[which(design2$treat == "C"),]
design.e <- design2[which(design2$treat == "E"),]

design.c <- design.c[order(design.c$pair),]
design.e <- design.e[order(design.e$pair),]



design.c$env == design.e$env

dist.raw <- as.matrix(dist.raw)

dist.pair <- as.data.frame(matrix(NA, dim(design.c)[1], 2))
colnames(dist.pair) <- c("distance", "env")
for (i in 1:dim(design.c)[1]){
  dist.pair[i, 1] <- dist.raw[row.names(design.e)[i], row.names(design.c)[i]]
  dist.pair[i, 2] <- as.character(design.c[i, 3])
} 

pair.mean <- aggregate(distance ~ env, dist.pair, mean)
pair.sem <- aggregate(distance ~ env, dist.pair, sem)

dist.raw.c <- dist.raw[which(design2$treat == "C"), which(design2$treat == "C")]
design2.c <- design2[design2$treat == "C", ]

dist.feces <- dist.raw.c[which(design2.c$env == "feces"),which(design2.c$env == "feces")]
dist.feces.m <- mean(dist.feces[lower.tri(dist.feces)])

dist.soil <- dist.raw.c[which(design2.c$env == "soil"),which(design2.c$env == "soil")]
dist.soil.m <- mean(dist.soil[lower.tri(dist.soil)])

dist.sed <- dist.raw.c[which(design2.c$env == "sed"),which(design2.c$env == "sed")]
dist.sed.m <- mean(dist.sed[lower.tri(dist.sed)])

dist.water <- dist.raw.c[which(design2.c$env == "water"),which(design2.c$env == "water")]
dist.water.m <- mean(dist.water[lower.tri(dist.water)])

dist.env <- c(dist.feces.m, dist.soil.m, dist.sed.m, dist.water.m)
```


```{r}

par(mar = c(5, 8, 1, 1) + 0.5)
plot(pair.mean$distance, 1:4, type = "n",
     xlim = c(0, 1), ylim = c(0.5, 4.5), axes = F,
     xlab = "", ylab = "")


arrows(y0 = 1:4, x0 = pair.mean$distance, 
       x1 = pair.mean$distance - pair.sem$distance, 
       angle = 90, length = 0.1, lwd = 2)
arrows(y0 = 1:4, x0 = pair.mean$distance, 
       x1 = pair.mean$distance + pair.sem$distance, 
       angle = 90, length = 0.1, lwd = 2)
points(pair.mean$distance, 1:4, cex = 3, pch = 22, 
       lwd = 2, col = "black", bg = "white")
abline(v = dist.env, lwd = 2, lty = 3)

axis(side = 1, labels = T, lwd.ticks = 2, cex.axis = 1.25, las = 1)
axis(side = 2, at = c(1:4), labels = c("Water", "Soil", "Sediment", "Feces"), lwd.ticks = 2, cex.axis = 1.25, las = 1)
axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=-0.02)
axis(side = 1, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
axis(side = 2, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
axis(side = 3, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)
axis(side = 4, labels = F, lwd.ticks = 2, cex.axis = 1, las = 1, tck=0.01)

mtext("Environment", side = 2, cex = 1.5, line = 6)
mtext("Pair Dissimilarity", side = 1, cex = 1.5, line = 3)

rect(0.55, 0.6, 0.9, 1.3, col = "white", border = NA)
text(dist.env, y = 0.9, labels = c("feces", "soil", "sed", "water"), 
     srt = 90, cex = 0.8)

legend("topleft", "Avg. Env. Dis.", lty = 3, lwd = 1.5, bty = "n")

box(lwd = 2)

pair.mean


```

  
```{r}
OTU.REL.c <- OTU.REL[which(design2$treat == "C"), ]
OTU.REL.e <- OTU.REL[which(design2$treat == "E"), ]

design2.c <- design2[which(design2$treat == "C"), ]
design2.e <- design2[which(design2$treat == "E"), ]

OTU.REL.c <- OTU.REL.c[order(design2.c$samp.code), ]
OTU.REL.e <- OTU.REL.e[order(design2.e$samp.code), ]

dist.c <- vegdist(OTU.REL.c, "bray")
dist.e <- vegdist(OTU.REL.e, "bray")

mantel.rtest(dist.c, dist.e)

```
  
  

3) Things to look into...


  --> Does pairwise dissimilarity in composition increase with eDNA content?


