---
title: "eDNA"
author: "Jay T. Lennon, Mario E. Muscarella, ..."
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes:
  - \usepackage{array}
output: pdf_document
geometry: margin=2.54cm
---

Analysis of quantitative PCR data to test whether the abundance of bacterial
communities is affected by extracellular DNA

# Setup Work Environment
```{r, results='hide', warning=FALSE, message=FALSE}
#rm(list=ls())
getwd()
setwd("~/GitHub/relicDNA/code")
require("plyr")
require("grid")
require("png")
require("car")
require("bbmle")
sem <- function(x, ...){sd(x, na.rm = TRUE)/sqrt(length(na.omit(x)))}
```

# Load data and calcualte corrected copy number
```{r}
eDNA.raw <- read.table("../data/eDNA_qPCR.txt", sep = "\t", header = T)

# Correct for dilutions and sample processing

# eDNA.raw[,7] = copies not corrected by dilution factor
# eDNA.raw[,8] = dilution factor
# eDNA.raw[,9] = volume (uL) in supernatant of phenol-chloroform extraction
# eDNA.raw[,10] = volume (ul) from supernatant of phenol-chlorofom subsampled

copies.corr <- eDNA.raw[,7] * (eDNA.raw[,8] * (eDNA.raw[,9]/eDNA.raw[,10]))

# Make new dataframe with corrected copy numbers
eDNA.corr <- data.frame(eDNA.raw, copies.corr)
```

# Take mean of technical replicates and sort
```{r}
# Use `aggregate` to return means of subsamples taken for each sample
eDNA <- aggregate(eDNA.corr$copies.corr ~ eDNA.corr$sample + eDNA.corr$sample_name +
                  eDNA.corr$env + eDNA.corr$treat, eDNA.corr, mean)

# Sort by sample number
eDNA <- eDNA[order(eDNA[,1]) ,]

# Rename columns
colnames(eDNA) <- c("sample.number", "sample.name", "env", "treat", "copy.number")
```

# Calculate proportion of degradable DNA per sample and test differences
```{r}
# Use `ddply` to return the DNase-1 degradable proportion of 16S rRNA gene copy
eDNA.prop <- ddply(eDNA, .(sample.number, sample.name, env), summarize,
                   prop = 1 - ((copy.number[treat == "E"]) / (copy.number[treat == "C"])))

# Sort by environment
eDNA.prop <- eDNA.prop[order(eDNA.prop[,3]) ,]

# Three samples (cat feces [32], human feces [28], T7Core) have negative proportions
# Set these to zero (i.e., no eDNA)
eDNA.prop$prop <- ifelse(eDNA.prop$prop < 0, 0, eDNA.prop$prop)
write.table(eDNA.prop, "../data/relicDNA.prop.txt", sep = "\t", col.names = T, row.names = F)

# Distribution of eDNA
qqnorm(eDNA.prop$prop)
plot(density(eDNA.prop$prop))
mean(eDNA.prop$prop)
sd(eDNA.prop$prop)
min(eDNA.prop$prop)
max(eDNA.prop$prop)

# Use glm to test whether amount of eDNA differs among environments
eDNA.prop.test <- glm(prop ~ env, data = eDNA.prop)
summary(eDNA.prop.test)
Anova(eDNA.prop.test, type = "II", test.statistic = "F")

# Use Anova to test whether the amount of dDNA differs among environments
eDNA.prop.lm <- lm(prop ~ env, data = eDNA.prop)
summary(eDNA.prop.lm)
eDNA.anova <- Anova(eDNA.prop.lm, type = "II")
eDNA.anova

TukeyHSD(aov(eDNA.prop.lm), "env")

# Calculate means, sem, and sample size by enviroment
eDNA.mean <- aggregate(eDNA.prop$prop ~ eDNA.prop$env, eDNA.prop, mean)
eDNA.n <- aggregate(eDNA.prop$prop ~ eDNA.prop$env, eDNA.prop, length)
eDNA.sem <- aggregate(eDNA.prop$prop ~ eDNA.prop$env, eDNA.prop, sem)

# Make table of proportion eDNA by environment
eDNA.table <- data.frame(eDNA.mean, eDNA.sem[ ,2], eDNA.n[ ,2])
colnames(eDNA.table) <- c("env", "mean", "sem", "n")
eDNA.table <- eDNA.table[order(eDNA.table[,2]), ]

```

# Make bar plot with error bars by environment
```{r, eval=F}
png(filename="../figures/qPCR.bar.png",
    width = 800, height = 800, res = 96*2)

bp <- barplot(eDNA.table$mean, ylim =c(0, 0.6),
              pch = 15, cex = 1.25, las = 1, cex.lab = 1.25, cex.axis = 1,
              col = "gray90", axis.lty = 1, lwd = 2, xlab = NA,
              ylab = "Proportion eDNA",
              names.arg = c("Soil", "Sediment", "Gut", "Water"), cex.names = 0.9)
              box(lwd = 2)
arrows(x0 = bp, y0 = eDNA.table$mean, y1 = eDNA.table$mean - eDNA.table$sem,
       angle = 90,  length = 0.1, lwd = 2)
arrows(x0 = bp, y0 = eDNA.table$mean, y1 = eDNA.table$mean + eDNA.table$sem,
       angle = 90, length=0.1, lwd = 2)

# Close Plot Device
dev.off()
graphics.off()

# Show Plot
img <- readPNG("../figures/qPCR.bar.png")
grid.raster(img)
```

# Make x-y plot with error bars by environment
```{r}
png(filename="../figures/Figure2-Prop_eDNA.png",
    width = 800, height = 800, res = 96*2)

par(mar = c(3, 5, 1, 1))
non.bp <- plot(eDNA.table$mean, ylim = c(0, 0.6),
               xlim = c(0.5, 4.5), pch = 22, bg = "gray90", lwd = 2,
               cex = 3, yaxt = "n", xaxt = "n", cex.lab = 2, cex.axis = 1.5,
               las = 1, ylab = "", xlab = "")
box(lwd = 2)

mtext(expression('Proportion Relic DNA'), side = 2,
      outer = FALSE, cex = 1.5, line = 3, adj = 0.5)

# Major Axes
axis(side = 2, lwd.ticks = 2, cex.axis = 1.25, las = 1,
     labels = c(0.0, 0.2, 0.4, 0.6), at = c(0.0, 0.2, 0.4, 0.6))

axis(side = 4, lwd.ticks = 2, cex.axis = 1.5, las = 1,
     at=c(0.0, 0.2, 0.4, 0.6), labels = F, tck = -0.02)

axis(side = 1, lwd.ticks = 2, cex.axis = 0.9, las = 1,
     labels = c("Soil", "Sediment", "Gut", "Water"), at = c(1, 2, 3, 4))

axis(side = 3, lwd.ticks = 2, cex.axis = 1.5, las = 1,
     at = c(1, 2, 3, 4), labels = F, tck = -0.02)

axis(side = 1, labels = F, lwd.ticks = 2, tck = 0.02, at = c(1, 2, 3, 4))
axis(side = 2, labels = F, lwd.ticks = 2, tck = 0.02, at = c(0, 0.2, 0.4, 0.6))
axis(side = 3, labels = F, lwd.ticks = 2, tck = 0.02, at = c(1, 2, 3, 4))
axis(side = 4, labels = F, lwd.ticks = 2, tck = 0.02, at = c(0, 0.2, 0.4, 0.6))

arrows(x0 = c(1, 2, 3, 4), y0 = eDNA.table$mean,
       y1 = eDNA.table$mean - eDNA.table$sem, angle = 90,
       length = 0.1, lwd = 2)

arrows(x0 = c(1,2,3,4), y0 = eDNA.table$mean,
       y1 = eDNA.table$mean + eDNA.table$sem, angle = 90,
       length=0.1, lwd = 2)

points(x = c(1:4), eDNA.table$mean,
      pch = 22, bg = "gray90", lwd = 2, cex = 3)

# Close Plot Device
dev.off()
graphics.off()

# Show Plot
img <- readPNG("../figures/Figure2-Prop_eDNA.png")
grid.raster(img)
```

# Optimizing DNAse concentration
```{r}
eDNA.DNase.raw <- read.table("../data/eDNA_DNase.txt", sep = "\t", header = T)

# Correct for dilutions and sample processing

# eDNA.DNase.raw[,7] = copies not corrected by dilution factor
# eDNA.DNase.raw[,8] = dilution factor
# eDNA.DNase.raw[,9] = volume (uL) in supernatant of phenol-chloroform extraction
# eDNA.DNase.raw[,10] = volume (ul) from supernatant of phenol-chlorofom subsampled

DNase.copies.corr <- eDNA.DNase.raw[,7] * (eDNA.DNase.raw[,8] * (eDNA.DNase.raw[,9]/eDNA.DNase.raw[,10]))

# Make new dataframe with corrected copy numbers
eDNA.DNase.corr <- data.frame(eDNA.DNase.raw, DNase.copies.corr)

# Use `ddply` to return the DNase-1 degradable proportion of 16S rRNA gene copy
eDNA.DNase.prop <- ddply(eDNA.DNase.corr, .(sample.name, Dnase), summarize,
                   prop = 1 - ((DNase.copies.corr[treat == "E"]) / (DNase.copies.corr[treat == "C"])))

## Run MLE
#starting values 
V = 0.55 
K = 5 
Z = 10

# Michaelis-Menten
fit <- mle2(eDNA.DNase.prop$prop ~ dnorm(mean = v * eDNA.DNase.prop$Dnase / (K + eDNA.DNase.prop$Dnase), sd = z), 
    start = list(v = V, k = K, z = Z), data = eDNA.DNase.prop)

# Plot Data
png(filename="~/GitHub/relicDNA/figures/FigureS6-DNase.png",
    width = 1200, height = 1200, res = 96*2)

plot.new()
par(mar = c(7, 7, 5, 7))

plot(eDNA.DNase.prop$Dnase, eDNA.DNase.prop$prop, xlim = c(0, 70), 
     ylim = c(0, 1), type = "p", 
     pch = 22, bg = "grey", col = "black", cex = 2, ylab = "", xlab = "", 
     cex.lab = 1.5, las = 1, lwd = 2, yaxt = "n", xaxt = "n")
box(lwd=2)

# Add ticks and tick labels
axis(side = 2, lwd.ticks = 2, las = 1, cex.axis = 1.25, 
   labels = c("0.0", "0.25", "0.5", "0.75", "1.0"), at = c(0, 0.25, 0.5, 0.75, 1.0))

axis(side = 4, labels = F, lwd.ticks = 2, 
   at = c(0, 0.25, 0.5, 0.75, 1.0))

axis(side = 1, lwd.ticks = 2, cex.axis = 1.25, las = 1, mgp = c(3, 1, 0),
    labels = c(0, 20, 40, 60), at = c(0, 20, 40, 60))

axis(side = 3, labels = F, lwd.ticks = 2, las = 1, cex.axis = 1.25, 
   at = c(0, 20, 40, 60))

mtext(expression(paste("DNAse (", mu, "L)")), side = 1, outer = TRUE, cex = 1.5, 
      line = -4, adj = 0.5)

mtext(expression(paste('Relic DNA')), 
      side = 2, outer = TRUE, cex = 1.5, line = -3, adj = 0.6)

# Plot function
curve((coef(fit)[[1]] * x) / (coef(fit)[[2]] + x), from = 0, to = 60, add = TRUE, lty = 6, lwd = 2.5)

dev.off()
graphics.off()
```

